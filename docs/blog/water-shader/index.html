<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>
    <meta name="description" content="Using displacement shaders to create reflections with Lua, Love2D and GLSL"></meta>
    <meta property="og:title" content="Water surface shader for 2D Pixel art games"></meta>
    <meta property="twitter:title" content="Water surface shader for 2D Pixel art games"></meta>
    <meta property="twitter:description" content="Using displacement shaders to create reflections with Lua, Love2D and GLSL"></meta>

     
    <meta property="og:image" content></meta>
		<meta name="twitter:image" content>
    

    <meta property="og:site_name" content="InJuly"></meta>

    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="stylesheet" href="/assets/css/post.css">
    <link rel="stylesheet" href="/assets/css/theme.css">
    

    <script data-goatcounter="https://injuly.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>


    <title>Water surface shader for 2D Pixel art games</title>
  </head>

  <body>
    <div class="main">
      <div class="nav-container">
        <nav>
          <a href="/" class="nav-link">index</a>
          <a href="/about" class="nav-link">about</a>
          <a href="/blog" class="nav-link active-nav-link">blog</a>
          <a href="/now" class="nav-link">now</a>
        </nav>
      </div>

      <div class="leader">
        <h1> Water surface shader for 2D Pixel art games </h1>
				<div class="post-date"> Sep 21 </div>
        <div class="tags" id="tags">
            <a class="tag" href="/posts/index.html?tag=post">post</a>
            <a class="tag" href="/posts/index.html?tag=games">games</a>
            <a class="tag" href="/posts/index.html?tag=lua">lua</a>
            <a class="tag" href="/posts/index.html?tag=love">love</a>
            <a class="tag" href="/posts/index.html?tag=GLSL">GLSL</a>
        </div>
      </div>
      <p>While browsing the LÖVE2D forums,
I came across <a href="https://alexjgriffith.itch.io/potions">potions</a>: A game where you brew potions to save your cat.
As soon as I booted the game, the reflections in the water surfaces caught my attention:</p>
<p><img src="https://img.itch.zone/aW1nLzEzNDMwMjQ4LmdpZg==/original/P7lZvp.gif" alt="Water reflections in potions"></img></p>
<p>There are two noteworthy effects that sell the presence of water:
real-time reflections of in-game objects close to the edges, and
the wavy disorted appearance of the reflected image.</p>
<p>I attempted a recreation of this effect, and ended up with this:</p>
<p><img src="/assets/img/water-shader/final-water-reflection.gif" alt="My recreation of the water effect from Potions"></img></p>
<p>Here, I&#39;ll document the entire process of getting a reflection system up and running.
I&#39;m using the Love game framework, and Lua as its scripting language (the original game is in <a href="https://fennel-lang.org/">Fennel</a>).</p>
<p>If you only want to see the shader logic, skip to <a href="#reflection-effect-with-displacement-shaders">this section</a>.</p>
<h2 id="project-setup">Project setup</h2>
<p>I&#39;m using some hand-drawn sprites for this demo.
If you&#39;re going to follow along, download all images from <a href="https://github.com/srijan-paul/shader-blog/tree/main/assets">here</a>,
and put them under an <code>assets</code> directory in your project root.</p>
<p>Every love project starts with <code>main.lua</code>.
Since we will be using low-res pixel-art sprites for this demo, the scaling filter is set to <code>nearest</code>:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: main.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>setDefaultFilter<span class="op">(</span><span class="st">&quot;nearest&quot;</span><span class="op">,</span> <span class="st">&quot;nearest&quot;</span><span class="op">)</span></span></code></pre></div></code></pre>
<p>In another file, <code>constants.lua</code>, we initialize some global constants that will be accessed throughout the game:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: constants.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="op">{</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- size of each tile in pixels.</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>    <span class="va">TileSize</span> <span class="op">=</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- the scale to which each tile is drawn</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>    <span class="va">TileScale</span> <span class="op">=</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- #rows of tiles in the game world</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>    <span class="va">RowCount</span> <span class="op">=</span> <span class="dv">25</span><span class="op">,</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- #columns of tiles in the game world</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>    <span class="va">ColCount</span> <span class="op">=</span> <span class="dv">25</span><span class="op">,</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- &quot;enums&quot; for tile kinds</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a>    <span class="va">TileWater</span>  <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a>    <span class="va">TileGround</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></code></pre>
<p>Import the constants in the main script:</p>
<code class="language-diff"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a>love.graphics.setDefaultFilter(&quot;nearest&quot;, &quot;nearest&quot;)</span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="va">+ local const = require(&quot;constants&quot;)</span></span></code></pre></div></code></pre>
<p>The surface of our game-world is drawn using tiles which are drawn every frame.
We can store all tiles in a 2D table, and fill the entire array with <code>TileGround</code>.</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: main.lua:</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="co">-- contains all tiles in our game-world.</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">grid</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="va">const</span><span class="op">.</span><span class="va">RowCount</span><span class="op">,</span> <span class="dv">1</span> <span class="cf">do</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>  <span class="va">grid</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="va">j</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="va">const</span><span class="op">.</span><span class="va">ColCount</span><span class="op">,</span> <span class="dv">1</span> <span class="cf">do</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>      <span class="va">grid</span><span class="op">[</span><span class="va">i</span><span class="op">][</span><span class="va">j</span><span class="op">]</span> <span class="op">=</span> <span class="va">const</span><span class="op">.</span><span class="va">TileGround</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div></code></pre>
<p>We could loop over this table every frame and draw each tile individually with <code>love.graphics.draw</code>.
For larger game worlds, however, this will result in way too many unnecessary draw calls.
If we pre-render the world&#39;s surface to an off-screen canvas instead,
we can draw that canvas every frame instead and get away with just <code>draw</code> call per frame:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: main.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="co">-- @returns a canvas representing the surface of our game-world.</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> get_ground_tiles_layer<span class="op">(</span><span class="va">screen_width</span><span class="op">,</span> <span class="va">screen_height</span><span class="op">)</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- create an empty canvas</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">canvas</span> <span class="op">=</span> <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>newCanvas<span class="op">(</span><span class="va">screen_width</span><span class="op">,</span> <span class="va">screen_height</span><span class="op">)</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">dirt_tile</span> <span class="op">=</span> <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>newImage<span class="op">(</span><span class="st">&quot;assets/dirt-tile.png&quot;</span><span class="op">)</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- render all ground tiles on the canvas.</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>  <span class="va">canvas</span><span class="op">:</span>renderTo<span class="op">(</span><span class="kw">function</span><span class="op">()</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="va">const</span><span class="op">.</span><span class="va">RowCount</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span> <span class="cf">do</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="va">j</span> <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="va">const</span><span class="op">.</span><span class="va">ColCount</span> <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span> <span class="cf">do</span></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">x</span> <span class="op">=</span> <span class="va">j</span> <span class="op">*</span> <span class="op">(</span><span class="va">const</span><span class="op">.</span><span class="va">TileSize</span> <span class="op">*</span> <span class="va">const</span><span class="op">.</span><span class="va">TileScale</span><span class="op">)</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">y</span> <span class="op">=</span> <span class="va">i</span> <span class="op">*</span> <span class="op">(</span><span class="va">const</span><span class="op">.</span><span class="va">TileSize</span> <span class="op">*</span> <span class="va">const</span><span class="op">.</span><span class="va">TileScale</span><span class="op">)</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">tile_kind</span> <span class="op">=</span> <span class="va">grid</span><span class="op">[</span><span class="va">i</span> <span class="op">+</span> <span class="dv">1</span><span class="op">][</span><span class="va">j</span> <span class="op">+</span> <span class="dv">1</span><span class="op">]</span></span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">tile_kind</span> <span class="op">==</span> <span class="va">const</span><span class="op">.</span><span class="va">TileGround</span> <span class="cf">then</span></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a>          <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>draw<span class="op">(</span><span class="va">dirt_tile</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">y</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="va">const</span><span class="op">.</span><span class="va">TileScale</span><span class="op">,</span> <span class="va">const</span><span class="op">.</span><span class="va">TileScale</span><span class="op">)</span></span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="19"><a href="#19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="20"><a href="#20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span><span class="op">)</span></span>
<span id="21"><a href="#21" aria-hidden="true" tabindex="-1"></a></span>
<span id="22"><a href="#22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="va">canvas</span></span>
<span id="23"><a href="#23" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="24"><a href="#24" aria-hidden="true" tabindex="-1"></a></span>
<span id="25"><a href="#25" aria-hidden="true" tabindex="-1"></a></span></code></pre></div></code></pre>
<p>Now, we can initialize the canvas at boot time, and then draw it every frame:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: main.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">ground_tiles</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">love</span><span class="op">.</span>load<span class="op">()</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">screen_width</span>  <span class="op">=</span> <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>getWidth<span class="op">()</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">screen_height</span> <span class="op">=</span> <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>getHeight<span class="op">()</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>  <span class="va">ground_tiles</span> <span class="op">=</span> get_ground_tiles_layer<span class="op">(</span><span class="va">screen_width</span><span class="op">,</span> <span class="va">screen_height</span><span class="op">)</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">love</span><span class="op">.</span>draw<span class="op">()</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>  <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>draw<span class="op">(</span><span class="va">ground_tiles</span><span class="op">)</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div></code></pre>
<p>If we launch what we have so far using the <code>love</code> command, it should look like this:</p>
<p><img src="/assets/img/water-shader/all-ground-tiles.png" alt="Ground tiles"></img></p>
<h2 id="adding-water">Adding Water</h2>
<p>In a real game, bodies of water are either defined in a large table called tile-map,
or generated procedurally. For a small demo, we can just store the bounds of our water-body in a table:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: main.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">lake</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>  <span class="va">begin</span> <span class="op">=</span> <span class="op">{</span> <span class="va">row</span> <span class="op">=</span> <span class="dv">4</span><span class="op">,</span> <span class="va">col</span> <span class="op">=</span> <span class="dv">3</span> <span class="op">},</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>  <span class="va">width</span> <span class="op">=</span> <span class="dv">5</span><span class="op">,</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>  <span class="va">height</span> <span class="op">=</span> <span class="dv">3</span> </span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></code></pre>
<p>Then, modify the existing grid-generation code to account for water-tiles:</p>
<code class="language-diff"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a> for i = 1, const.RowCount, 1 do</span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>   grid[i] = {}</span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>   for j = 1, const.ColCount, 1 do</span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="va">+    if i &gt;= lake.begin.row and i &lt; lake.begin.row + lake.height and</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="va">+        j &gt;= lake.begin.col and j &lt; lake.begin.col + lake.width then</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="va">+      grid[i][j] = const.TileWater</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a><span class="va">+    else</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>       grid[i][j] = const.TileGround</span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a><span class="va">+    end</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>   end</span></code></pre></div></code></pre>
<p>If we run our program now, we&#39;ll see a black void in the center of our map:</p>
<p><img src="/assets/img/water-shader/waterless-void.png" alt="Water-less void"></img></p>
<p>This happens because the <code>ground_tiles</code> canvas only draws a tile when there is a <code>TileGround</code>
in the current grid cell.</p>
<p>I wanted my water to be animated, so I drew a simple sprite with four frames:</p>
<img src="/assets/img/water-shader/water-tile.gif" alt="Water tile sprite" width="200px" height="200px"></img>
<p>In the project directory, I have each frame saved as <code>assets/water-tile1.png</code>, <code>assets/water-tile2.png</code>, etc.</p>
<p>To get this water on to the screen, we&#39;ll place use another canvas that is drawn <em>under</em> the ground canvas.
The code for this animated canvas can be put into its own module:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: water.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">const</span> <span class="op">=</span> <span class="fu">require</span><span class="op">(</span><span class="st">&quot;constants&quot;</span><span class="op">)</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="co">-- helper function to load each frame in the animation as an Image object`</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> load_water_tile<span class="op">(</span><span class="va">index</span><span class="op">)</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">assert</span><span class="op">(</span><span class="va">index</span> <span class="op">&gt;=</span> <span class="dv">1</span> <span class="kw">and</span> <span class="va">index</span> <span class="op">&lt;=</span> <span class="dv">4</span><span class="op">)</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">file_path</span> <span class="op">=</span> <span class="st">&quot;assets/water-tile&quot;</span> <span class="op">..</span> <span class="va">index</span> <span class="op">..</span> <span class="st">&quot;.png&quot;</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">water_tile</span> <span class="op">=</span> <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>newImage<span class="op">(</span><span class="va">file_path</span><span class="op">)</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="va">water_tile</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a><span class="co">-- water_tile_imgs[i] = i-th frame in the animation</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">water_tile_imgs</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a>  load_water_tile<span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a>  load_water_tile<span class="op">(</span><span class="dv">2</span><span class="op">),</span></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a>  load_water_tile<span class="op">(</span><span class="dv">3</span><span class="op">),</span></span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a>  load_water_tile<span class="op">(</span><span class="dv">4</span><span class="op">)</span></span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></code></pre>
<p>Just as before, we can either iterate over all water tiles and draw each one separately,
or use one canvas for each frame that will draw all tiles.
Using the second approach, the water animation will cycle through 4 canvases.
Each canvas will display one sprite repeated enough times to cover the entire screen.</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: water.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="co">-- create a canvas that draws `tile_img` in a repeating pattern.</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> make_water_layer<span class="op">(</span><span class="va">tile_img</span><span class="op">,</span> <span class="va">n_rows</span><span class="op">,</span> <span class="va">n_cols</span><span class="op">)</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">canvas</span> <span class="op">=</span> <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>newCanvas<span class="op">(</span><span class="dv">800</span><span class="op">,</span> <span class="dv">600</span><span class="op">)</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>  <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>setColor<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>  <span class="va">canvas</span><span class="op">:</span>renderTo<span class="op">(</span><span class="kw">function</span><span class="op">()</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="va">n_rows</span> <span class="cf">do</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="va">j</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="va">n_cols</span> <span class="cf">do</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">x</span> <span class="op">=</span> <span class="op">(</span><span class="va">j</span> <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">const</span><span class="op">.</span><span class="va">TileSize</span> <span class="op">*</span> <span class="va">const</span><span class="op">.</span><span class="va">TileScale</span><span class="op">)</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">local</span> <span class="va">y</span> <span class="op">=</span> <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="va">const</span><span class="op">.</span><span class="va">TileSize</span> <span class="op">*</span> <span class="va">const</span><span class="op">.</span><span class="va">TileScale</span><span class="op">)</span></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a>        <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>draw<span class="op">(</span><span class="va">tile_img</span><span class="op">,</span> <span class="va">x</span><span class="op">,</span> <span class="va">y</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="va">const</span><span class="op">.</span><span class="va">TileScale</span><span class="op">,</span> <span class="va">const</span><span class="op">.</span><span class="va">TileScale</span><span class="op">)</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a>      <span class="cf">end</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">end</span><span class="op">)</span></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="va">canvas</span></span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a></span>
<span id="19"><a href="#19" aria-hidden="true" tabindex="-1"></a><span class="co">-- Make 4 canvases, one for each frame of the water animation.</span></span>
<span id="20"><a href="#20" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="kw">function</span> make_water_layers<span class="op">()</span></span>
<span id="21"><a href="#21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">water_layers</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="22"><a href="#22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="va">i</span> <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">4</span> <span class="cf">do</span></span>
<span id="23"><a href="#23" aria-hidden="true" tabindex="-1"></a>    <span class="va">water_layers</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">=</span> make_water_layer<span class="op">(</span><span class="va">water_tile_imgs</span><span class="op">[</span><span class="va">i</span><span class="op">],</span> <span class="va">const</span><span class="op">.</span><span class="va">RowCount</span><span class="op">,</span> <span class="va">const</span><span class="op">.</span><span class="va">ColCount</span><span class="op">)</span></span>
<span id="24"><a href="#24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="25"><a href="#25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="va">water_layers</span></span>
<span id="26"><a href="#26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div></code></pre>
<p>Now that we have these helpers,
we can manage the state for all water tiles in one object:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: water.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">Water</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">Water</span><span class="op">:</span>new<span class="op">()</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">w</span> <span class="op">=</span>  <span class="op">{}</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setmetatable</span><span class="op">(</span><span class="va">w</span><span class="op">,</span> <span class="va">self</span><span class="op">)</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>  <span class="va">self</span><span class="op">.</span><span class="va">__index</span> <span class="op">=</span> <span class="va">self</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>  <span class="va">self</span><span class="op">.</span><span class="va">frames</span> <span class="op">=</span> make_water_layers<span class="op">()</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>  <span class="va">self</span><span class="op">.</span><span class="va">current_frame</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>  <span class="va">self</span><span class="op">.</span><span class="va">frame_duration</span> <span class="op">=</span> <span class="dv">0.15</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>  <span class="va">self</span><span class="op">.</span><span class="va">current_frame_time</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="va">w</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a></span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">Water</span><span class="op">:</span>draw<span class="op">()</span></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">frame</span> <span class="op">=</span> <span class="va">self</span><span class="op">.</span><span class="va">frames</span><span class="op">[</span><span class="va">self</span><span class="op">.</span><span class="va">current_frame</span><span class="op">]</span></span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a>  <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>draw<span class="op">(</span><span class="va">frame</span><span class="op">)</span></span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="19"><a href="#19" aria-hidden="true" tabindex="-1"></a></span>
<span id="20"><a href="#20" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">Water</span><span class="op">:</span>update_water<span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span id="21"><a href="#21" aria-hidden="true" tabindex="-1"></a>  <span class="va">self</span><span class="op">.</span><span class="va">current_frame_time</span> <span class="op">=</span> <span class="va">self</span><span class="op">.</span><span class="va">current_frame_time</span> <span class="op">+</span> <span class="va">dt</span></span>
<span id="22"><a href="#22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="va">self</span><span class="op">.</span><span class="va">current_frame_time</span> <span class="op">&gt;=</span> <span class="va">self</span><span class="op">.</span><span class="va">frame_duration</span> <span class="cf">then</span></span>
<span id="23"><a href="#23" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span><span class="op">.</span><span class="va">current_frame_time</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="24"><a href="#24" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span><span class="op">.</span><span class="va">current_frame</span> <span class="op">=</span> <span class="op">(</span><span class="va">self</span><span class="op">.</span><span class="va">current_frame</span> <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="25"><a href="#25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="va">self</span><span class="op">.</span><span class="va">current_frame</span> <span class="op">&gt;</span> <span class="op">#</span><span class="va">self</span><span class="op">.</span><span class="va">frames</span> <span class="cf">then</span></span>
<span id="26"><a href="#26" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span><span class="op">.</span><span class="va">current_frame</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="27"><a href="#27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="28"><a href="#28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">end</span></span>
<span id="29"><a href="#29" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="30"><a href="#30" aria-hidden="true" tabindex="-1"></a></span>
<span id="31"><a href="#31" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="va">Water</span></span></code></pre></div></code></pre>
<p>We could have kept the ground and water tiles on the same layer using a single canvas.
The reason for not doing this should become clear once we write the distortion shader.</p>
<p>For now, we can initialize the water surface in <code>love.load</code> (<code>main.lua</code>):</p>
<code class="language-diff"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="st">-local ground_tiles</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="va">+local ground_tiles, water_tiles</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a> function love.load()</span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>   local screen_width  = love.graphics.getWidth()</span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>   local screen_height = love.graphics.getHeight()</span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>   ground_tiles = get_ground_tiles_layer(screen_width, screen_height)</span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a><span class="va">+  water_tiles  = Water:new()</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a> end</span></code></pre></div></code></pre>
<p>Modify the draw function to render the water surface (<code>main.lua</code>):</p>
<code class="language-diff"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a>function love.draw()</span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="va">+ water_tiles:draw()</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>  love.graphics.draw(ground_tiles)</span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>end</span></code></pre></div></code></pre>
<p>And update the water tiles on every time-step:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: main.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">love</span><span class="op">.</span>update<span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>  <span class="va">water_tiles</span><span class="op">:</span>update_water<span class="op">(</span><span class="va">dt</span><span class="op">)</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div></code></pre>
<p>Now, the void in our map should be filled with animated water:</p>
<p><img src="/assets/img/water-shader/bland-water.gif" alt="Animated water"></img></p>
<p>The borders of our water body look too straight and unnatural right now, and there is no sense of depth.
We can fix that by drawing borders on top any water tile that is adjacent to a ground tile.</p>
<p>For that, we need to draw some sprites for each border-type (left/right/top-left/top-right), and render them on top of the right tiles.
<a href="https://github.com/srijan-paul/shader-blog/blob/e3aa7be34abbaf1512004987edbaf2232d23ee1e/main.lua#L72">The code</a> for this is boring, and not the point of this post, so I will not explain it here.</p>
<p>After adding borders, the water should look like this:</p>
<p><img src="/assets/img/water-shader/water-with-border.gif" alt="Water body with borders"></img></p>
<h2 id="drawing-reflections">Drawing reflections</h2>
<p>We could, if we wanted to, have an isometric pixel-art game and do fancy ray-tracing to show reflections.
However, there is a much simpler trick used by many games before ray-tracing was feasible –
drawing a copy of every entity on reflective surfaces.</p>
<p>First, we&#39;ll need a class that represents a drawable sprite:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: sprite.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">Sprite</span> <span class="op">=</span> <span class="op">{}</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="va">Sprite</span><span class="op">.</span><span class="va">__index</span> <span class="op">=</span> <span class="va">Sprite</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">Sprite</span><span class="op">:</span>new<span class="op">(</span><span class="va">quad</span><span class="op">,</span> <span class="va">scale</span><span class="op">)</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>  <span class="va">scale</span> <span class="op">=</span> <span class="va">scale</span> <span class="kw">or</span> <span class="dv">1</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">local</span> <span class="va">sprite</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>    <span class="va">quad</span> <span class="op">=</span> <span class="va">quad</span><span class="op">,</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>    <span class="va">scale_x</span> <span class="op">=</span> <span class="va">scale</span><span class="op">,</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>    <span class="va">scale_y</span> <span class="op">=</span> <span class="va">scale</span><span class="op">,</span></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a>    <span class="va">w</span> <span class="op">=</span> <span class="va">quad</span><span class="op">:</span>getWidth<span class="op">()</span> <span class="op">*</span> <span class="va">scale</span><span class="op">,</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a>    <span class="va">h</span> <span class="op">=</span> <span class="va">quad</span><span class="op">:</span>getHeight<span class="op">()</span> <span class="op">*</span> <span class="va">scale</span><span class="op">,</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a>    <span class="va">rot</span> <span class="op">=</span> <span class="dv">0</span></span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">setmetatable</span><span class="op">(</span><span class="va">sprite</span><span class="op">,</span> <span class="va">Sprite</span><span class="op">)</span></span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="va">sprite</span></span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div></code></pre>
<p>A sprite object stores an image to render, and its scale, width, and height.
Using this information, we can write two <code>draw</code> methods, one to draw the image itself,
and another to draw its reflection.</p>
<p>A reflection looks exactly the same as the image itself, just flipped vertically.</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: sprite.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">Sprite</span><span class="op">:</span>draw<span class="op">(</span><span class="va">x</span><span class="op">,</span> <span class="va">y</span><span class="op">)</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>  <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>draw<span class="op">(</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span><span class="op">.</span><span class="va">quad</span><span class="op">,</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>    <span class="va">x</span> <span class="op">-</span> <span class="va">self</span><span class="op">.</span><span class="va">w</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>    <span class="va">y</span> <span class="op">-</span> <span class="va">self</span><span class="op">.</span><span class="va">h</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span><span class="op">.</span><span class="va">rot</span><span class="op">,</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span><span class="op">.</span><span class="va">scale_x</span><span class="op">,</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span><span class="op">.</span><span class="va">scale_y</span><span class="op">)</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="va">Sprite</span><span class="op">:</span>draw_reflection<span class="op">(</span><span class="va">x</span><span class="op">,</span> <span class="va">y</span><span class="op">)</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a>  <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>draw<span class="op">(</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span><span class="op">.</span><span class="va">quad</span><span class="op">,</span></span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a>    <span class="va">x</span> <span class="op">-</span> <span class="va">self</span><span class="op">.</span><span class="va">w</span> <span class="op">/</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a>    <span class="va">y</span> <span class="op">+</span> <span class="va">self</span><span class="op">.</span><span class="va">h</span> <span class="op">*</span> <span class="dv">1.5</span><span class="op">,</span></span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span><span class="op">.</span><span class="va">rot</span><span class="op">,</span></span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span><span class="op">.</span><span class="va">scale_x</span><span class="op">,</span></span>
<span id="19"><a href="#19" aria-hidden="true" tabindex="-1"></a>    <span class="co">-- notice the negative scale:</span></span>
<span id="20"><a href="#20" aria-hidden="true" tabindex="-1"></a>    <span class="op">-</span><span class="va">self</span><span class="op">.</span><span class="va">scale_y</span><span class="op">)</span></span>
<span id="21"><a href="#21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="22"><a href="#22" aria-hidden="true" tabindex="-1"></a></span>
<span id="23"><a href="#23" aria-hidden="true" tabindex="-1"></a><span class="co">-- export the Sprite class</span></span>
<span id="24"><a href="#24" aria-hidden="true" tabindex="-1"></a><span class="cf">return</span> <span class="va">Sprite</span></span></code></pre></div></code></pre>
<p>Now, we can import the sprite class in <code>main.lua</code>:</p>
<code class="language-diff"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a>local const = require(&quot;constants&quot;)</span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>local Water = require(&quot;water&quot;)</span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="va">+local Sprite = require(&quot;sprite&quot;)</span></span></code></pre></div></code></pre>
<p>and define a tree object with X-Y coordinates and a sprite:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">-- file: main.lua</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">tree_image</span> <span class="op">=</span> <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>newImage<span class="op">(</span><span class="st">&quot;assets/tree.png&quot;</span><span class="op">)</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">tree</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>  <span class="va">sprite</span> <span class="op">=</span> <span class="va">Sprite</span><span class="op">:</span>new<span class="op">(</span><span class="va">tree_image</span><span class="op">,</span> <span class="dv">4</span><span class="op">),</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>  <span class="va">x</span> <span class="op">=</span> <span class="dv">300</span><span class="op">,</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>  <span class="va">y</span> <span class="op">=</span> <span class="dv">135</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a><span class="co">-- function love.draw()</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a><span class="co">-- ...</span></span></code></pre></div></code></pre>
<p>We then update the <code>love.draw</code> function to draw the tree and its reflection:</p>
<code class="language-diff"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a>function love.draw()</span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>  water_tiles:draw()</span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>  love.graphics.draw(ground_tiles)</span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="va">+ tree.sprite:draw(tree.x, tree.y)</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="va">+ tree.sprite:draw_reflection(tree.x, tree.y)</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>end</span></code></pre></div></code></pre>
<p>Launching the game again, we see:</p>
<p><img src="/assets/img/water-shader/incorrect-reflection.png" alt="Incorrect reflection"></img></p>
<p>Hmm, there&#39;s something wrong with the reflection.
Try looking closer, and you&#39;ll notice that the reflection is drawn <em>over</em> the ground,
as if it were above the lake.</p>
<p>To restrict its sprite to the lake&#39;s bounds, we simply change the order of drawing so that
the water is drawn first, then all the reflections, and then the ground.
This way, tiles from the ground canvas will hide parts of the reflection image:</p>
<code class="language-diff"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a> function love.draw()</span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>   water_tiles:draw()</span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="va">+  tree.sprite:draw_reflection(tree.x, tree.y)</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>   love.graphics.draw(ground_tiles)</span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>   tree.sprite:draw(tree.x, tree.y)</span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="st">-  tree.sprite:draw_reflection(tree.x, tree.y)</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a> end</span></code></pre></div></code></pre>
<p>With that change, the reflection at least looks somewhat believable:</p>
<p><img src="/assets/img/water-shader/reflection-no-shader.gif" alt="Correct reflection"></img></p>
<p>And yet, it doesn&#39;t look very convincing.
For one, the color of the reflection is exactly the same as that of the object.
The surface of a lake isn&#39;t fully reflective, and will absorb more of red/green than blue.
We want the reflected image to have a bit of a blue tint.</p>
<p>Moreover, the water surface is moving, but the reflection is idle.
Ideally, moving water should distort the image.</p>
<h2 id="reflection-effect-with-displacement-shaders">Reflection effect with displacement shaders</h2>
<p>Right now, our render loop is pretty straightforward:</p>
<ol>
<li>Fill the entire screen with water tiles.
</li>
<li>Draw reflections of all in game objects (<code>scale = scale * -1</code>).
</li>
<li>Draw ground tiles.
</li>
<li>Draw all objects in our game world.
</li>
</ol>
<p>Separating each layer into its own canvas allows us to apply a shader globally,
draw a layer while that effect is active, and then remove the shader so
that other objects are drawn normally.</p>
<p>A shader is code that runs on the GPU, and applies an effect to every pixel in parallel (*).
<a href="https://blogs.love2d.org/content/beginners-guide-shaders">This post</a> is a good introduction to shaders in Love2D.
I recommend going through it before reading ahead.</p>
<p>Assuming you know the very basics of shaders, this one should be straightforward:</p>
<code class="language-lua"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">reflection_shader</span> <span class="op">=</span> <span class="va">love</span><span class="op">.</span><span class="va">graphics</span><span class="op">.</span>newShader <span class="vs">[[</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="vs">    vec4 effect(vec4 color, Image texture, vec2 uv, vec2 pixel_coords) { </span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="vs">      vec4 pixel_color = Texel(texture, uv);</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="vs">      pixel_color.b = clamp(pixel_color.b + 0.2, 0.0, 1.0);</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="vs">      return pixel_color;</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="vs">    }</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a><span class="vs">]]</span></span></code></pre></div></code></pre>
<p>The <code>effect</code> function receives the current color set using <code>love.graphics.setColor</code>,
the image being drawn to the screen (<code>texture</code>),
coordinates of the current pixel inside the image normalized to [0, 1] (<code>uv</code>),
and absolute coordinates of the current pixel inside the window. (<code>pixel_coords</code>).
It&#39;s purpose is to return a modified color for the pixel at <code>uv</code> in <code>texture</code>.</p>
<p><code>Texel(texture, uv)</code> gives us the color of the pixel at coordinate <code>uv</code> inside <code>texture</code>.
We then add <code>0.2</code> to the blue channel of the pixel and return  it.</p>
<p>We can apply this shader before drawing our reflections layer like so:</p>
<code class="language-diff"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a>function love.draw()</span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>  water_tiles:draw()</span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="va">+ love.graphics.setShader(reflection_shader)</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>  tree.sprite:draw_reflection(tree.x, tree.y)</span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="va">+ love.graphics.setShader()</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a>  love.graphics.draw(ground_tiles)</span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a>  tree.sprite:draw(tree.x, tree.y)</span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>end</span></code></pre></div></code></pre>
<p>Now, our reflections have a blue tint:</p>
<p><img src="/assets/img/water-shader/reflection-blue-tint.gif" alt="Reflection with a blue tint"></img></p>
<p>We also want the reflected image to twist and distort as if there are waves underneath.
The final reflection should look like this:</p>
<p><img src="/assets/img/water-shader/final-water-reflection.gif" alt="Final result"></img></p>
<p>This effect can be realized with one simple trick – for every <code>(X, Y)</code> coordinate in the image,
instead of drawing the the pixel at <code>(X, Y)</code>, draw the pixel at <code>(X + dx, Y + dy)</code>.
Tweaking the values of <code>dx</code> and <code>dy</code> will lead us to various kinds of displacements.</p>
<p>Remember that our normalized <code>(X, Y)</code> coordinates are in the range <code>[0, 1]</code>,
so we must not budge them too much, <code>dx</code> and <code>dy</code> must be small numbers.</p>
<p>To sell the effect of a smooth water surface, the values of <code>dx</code> and <code>dy</code>
must change smoothly as we go in one direction along the canvas.</p>
<p>Moreover, the distortion must update with time, and it should do so smoothly without any jitter.
When you want a smoothly varying wave over time, sine waves can be a good bet.</p>
<p>To compute <code>dx</code>, I will be using the following equation:</p>
<code><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a>dx = wave_height </span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>   * sin(frequency*(X + speed * time))</span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>   * cos(frequency*(X + speed * time))</span></code></pre></div></code></pre>
<p><code>wave_height</code> is the <em>amount</em> of distortion.
The higher the <code>height</code>, the more streching/shrinking there is in the waves.
<code>frequency</code> determines how far apart two waves are spaced.
<code>time</code> always increases monotonically by itself.
<code>speed</code> tells us how fast the distortion effect updates.</p>
<p>It might not be intuitive immediately.
I recommend that you open <a href="https://www.desmos.com/calculator/k8qkzkijab">this graph</a> and play around with the sliders on the left
to see how each parameter changes the shape of the graph.</p>
<p>Parameters like <code>wave_height</code>, <code>time</code>, etc. are uniforms that will be sent to the shader from our Lua program.
The updated shader is:</p>
<code class="language-c++"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">//  These are passed to the shader from the Lua script.</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>uniform <span class="dt">float</span> time<span class="op">;</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>uniform <span class="dt">float</span> wave_height<span class="op">;</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>uniform <span class="dt">float</span> wave_speed<span class="op">;</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>uniform <span class="dt">float</span> wave_freq<span class="op">;</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a>vec4 effect<span class="op">(</span>vec4 color<span class="op">,</span> Image texture<span class="op">,</span> vec2 uv<span class="op">,</span> vec2 pixel_coords<span class="op">)</span> <span class="op">{</span> </span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Displace the `x` coordinate. </span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>  uv<span class="op">.</span>x <span class="op">+=</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>    sin<span class="op">((</span>uv<span class="op">.</span>y <span class="op">+</span> time <span class="op">*</span> wave_speed<span class="op">)</span> <span class="op">*</span> wave_freq<span class="op">)</span></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> cos<span class="op">((</span>uv<span class="op">.</span>y <span class="op">+</span> time <span class="op">*</span> wave_speed<span class="op">)</span> <span class="op">*</span> wave_freq <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> wave_height<span class="op">;</span></span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a></span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Displacement in `y` is half that of `x`.</span></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Displacing `x` and `y` equally looks unnatural</span></span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a>  uv<span class="op">.</span>y <span class="op">+=</span></span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a>    sin<span class="op">((</span>uv<span class="op">.</span>x <span class="op">+</span> time <span class="op">*</span> wave_speed<span class="op">)</span> <span class="op">*</span> wave_freq<span class="op">)</span></span>
<span id="19"><a href="#19" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> cos<span class="op">((</span>uv<span class="op">.</span>x <span class="op">+</span> time <span class="op">*</span> wave_speed<span class="op">)</span> <span class="op">*</span> wave_freq <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span id="20"><a href="#20" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span> wave_height <span class="op">*</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="21"><a href="#21" aria-hidden="true" tabindex="-1"></a></span>
<span id="22"><a href="#22" aria-hidden="true" tabindex="-1"></a>  vec4 pixel <span class="op">=</span> Texel<span class="op">(</span>texture<span class="op">,</span> uv<span class="op">);</span></span>
<span id="23"><a href="#23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// apply a blue tint to the reflection</span></span>
<span id="24"><a href="#24" aria-hidden="true" tabindex="-1"></a>  pixel<span class="op">.</span>b <span class="op">+=</span> <span class="fl">0.2</span><span class="op">;</span></span>
<span id="25"><a href="#25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> pixel<span class="op">;</span></span>
<span id="26"><a href="#26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></code></pre>
<p>We update the <code>love.draw</code> function yet again to send these parameters to the shader.</p>
<code class="language-diff"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a>function love.draw()</span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a>  water_tiles:draw()</span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a><span class="va">+ local time = love.timer.getTime()</span></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="va">+ reflection_shader:send(&quot;time&quot;, time)</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="va">+ reflection_shader:send(&quot;wave_height&quot;, 0.02)</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a><span class="va">+ reflection_shader:send(&quot;wave_speed&quot;, 0.1)</span></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a><span class="va">+ reflection_shader:send(&quot;wave_freq&quot;, 45.0)</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a><span class="va">+</span></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a>  love.graphics.setShader(reflection_shader)</span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>... </span></code></pre></div></code></pre>
<p>With that change, the reflection looks a lot more natural:</p>
<p><img src="/assets/img/water-shader/final-water-reflection.gif" alt="Reflection with displacement"></img></p>
<p>I&#39;m happy with this re-creation, so I&#39;ll stop here.
The only thing that is probably missing is the shadow around the edges of the lake.
That can also be achieved by adding drawing some borders on top of water tiles near the edges,
and then applying the same shader with different parameters:</p>
<p><img src="/assets/img/water-shader/water-shadows.png" alt="Shadows around the water body"></img></p>
<h2 id="backmatter">Backmatter</h2>
<p>I recently found out about <a href="https://alexjgriffith.itch.io/potions/devlog/588358/the-one-where-water-is-made">this write-up</a> by Alex Griffith – author of Potions.
Interestingly, their approach to the shader was very different from the one I took.
The shader used in the game uses a mask and a noise-map to decide the amount of distortion on each pixel.</p>


			<script src="https://giscus.app/client.js" data-repo="srijan-paul/srijan-paul.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzMTY0MTg0NTk=" data-category="Announcements" data-category-id="DIC_kwDOEtwpm84Cdokt" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" defer>
			</script>
		</div>
  </body>
</html>
