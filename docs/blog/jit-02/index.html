<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"></meta>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"></meta>
    <meta name="description" content="Exploring the Arm architecture in part 2 of the JIT compilation series"></meta>
    <meta property="og:title" content="JIT compiler from scratch – 2/3"></meta>
    <meta property="twitter:title" content="JIT compiler from scratch – 2/3"></meta>
    <meta property="twitter:description" content="Exploring the Arm architecture in part 2 of the JIT compilation series"></meta>

     
    <meta property="og:image" content></meta>
		<meta name="twitter:image" content>
    

    <meta property="og:site_name" content="InJuly"></meta>

		<link rel="preconnect" href="https://rsms.me/">
		<link rel="stylesheet" href="https://rsms.me/inter/inter.css">

    <link rel="stylesheet" href="/assets/css/common.css">
    <link rel="stylesheet" href="/assets/css/post.css">
    <link rel="stylesheet" href="/assets/css/theme.css">
    

    <script data-goatcounter="https://injuly.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>


    <title>JIT compiler from scratch – 2/3</title>
  </head>

  <body>
    <div class="main">
      <div class="nav-container">
        <nav>
          <a href="/" class="nav-link">index</a>
          <a href="/about/" class="nav-link">about</a>
          <a href="/blog/" class="nav-link active-nav-link">blog</a>
          <a href="/work/" class="nav-link">work</a>
          <a href="/now/" class="nav-link">now</a>
        </nav>
      </div>

      <div class="leader">
        <h1> JIT compiler from scratch – 2/3 </h1>
				<div class="post-date"> Nov 19 </div>
        <div class="tags" id="tags">
            <a class="tag" href="/tags/compilers.html">compilers</a>
            <a class="tag" href="/tags/assembly.html">assembly</a>
            <a class="tag" href="/tags/zig.html">zig</a>
            <a class="tag" href="/tags/programming-languages.html">programming-languages</a>
        </div>
      </div>
      <p>In the <a href="/jit-01/">previous post</a>, we set up a simple bytecode interpreter for a stack-based language.
Now, we&#39;ll study the Arm instruction-set, and see how we can generate and execute machine code
while a program is running.</p>
<p>I am on an Apple Silicon laptop, but you may not be.
To run Arm code on your machine, you can use <a href="https://www.qemu.org/download/">qemu</a>.</p>
<p>Alternatively, you can grab the x86-64 manual, and follow along with that instead.
If you&#39;re not intimately familiar with the relationship between machine code, assembly files, and C source,
it might be a good idea to read <a href="/blog/c-source-to-machine-code/">this short post</a> I wrote as a supplement to this guide.</p>
<h2 id="the-arm-instruction-set">The Arm instruction set.</h2>
<p>Everything I explain here was originally sourced from <a href="https://developer.arm.com/documentation/ddi0487/latest">the Arm reference manual</a>.
If you&#39;re going to follow along, I recommend having a local copy of the manual handy.</p>
<p>An Arm CPU can execute code in two modes: 64 and 32-bit.
For today&#39;s desktop computers, only the 64-bit mode is relevant, and is referred to as &quot;Aarch64&quot; in the manual.</p>
<p>An Arm machine has 31 general purpose registers, labelled <code>x0</code> through <code>x30</code>.
We&#39;ll refer to them as &quot;GPR&quot;s from here on out.
Apart from these, there are two &quot;special&quot; registers:</p>
<ol>
<li>SP – The stack pointer.
</li>
<li>ZR – A read-only register that always stores the constant <code>0</code>.
</li>
</ol>
<p>There are also SIMD, floating point, and SVE registers,
but we do not need them for our simple interpreter.
In fact, we only need to reference two sections of the manual:
C3, the A64 instruction set overview, and C4, the instruction set encoding.</p>
<p>The manual explains that every ARM instruction is a 32-bit integer,
and the CPU will decode this integer to figure out what its supposed to do.</p>
<p>For example, the <code>ret</code> instruction (used to return from a function) is encoded as
the integer <code>0xd65f03c0</code>.</p>
<p>The instruction used to add two registers together is represented as <code>ADD [Rd] [Rm] [Rn]</code>,
where <code>Rd</code> is the destination register, and <code>Rm</code> and <code>Rn</code> are the two source registers.</p>
<p>To explain the encoding of <code>ADD</code>, I&#39;ve made this table where
the left column lists the bit positions, and the right shows the value
stored in that slot of the machine code instruction.</p>
<table>
<thead>
<tr>
<th>Bit position</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>0-4</td>
<td><code>Rd</code></td>
</tr>
<tr>
<td>5-9</td>
<td><code>Rn</code></td>
</tr>
<tr>
<td>10-15</td>
<td><code>imm</code></td>
</tr>
<tr>
<td>16-20</td>
<td><code>Rm</code></td>
</tr>
<tr>
<td>21</td>
<td><code>0</code></td>
</tr>
<tr>
<td>22-23</td>
<td><code>shift</code></td>
</tr>
<tr>
<td>24-30</td>
<td><code>1101000</code></td>
</tr>
<tr>
<td>31</td>
<td><code>sf</code></td>
</tr>
</tbody>
</table>
<p>So in the 32-bit integer used to encode an ADD instruction,
the lowest five bits store the destination register, the next five
store the first source register, and bits <code>16-20</code> store the other source register.</p>
<p>The <code>shift</code> and <code>imm</code> bits can be safely ignored.
These are used for bit shifting, a.k.a scaling the addition by 2, 4, 8, etc.,
when computing array indices or adding pointers.
In our case, both of them will always be set to 0.</p>
<p>The <code>sf</code> bit is used to differentiate between A64 and A32 modes,
and will be <code>1</code> for us, since we only ever want A64.</p>
<p>Finally, the <code>01101000</code> in bits 24-30 is a unique bit sequence that the CPU
associates with an ADD instruction.
Think of it as the opcode.</p>
<p>Let&#39;s try encoding <code>ADD x0 x1 x0</code> using the table above.
By plugging in <code>00000</code>, <code>00001</code>, and <code>00000</code> in the slots for <code>Rd</code>, <code>Rm</code>,
and <code>Rn</code>, and setting <code>shift</code> and <code>imm</code> to 0, we get:</p>
<code><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a>0b1_00_01011_00_0_00000_000000_00001_00000</span></code></pre></div></code></pre>
<p>The hexadecimal value for this binary integer is <code>0x8B000020</code>, which
happens to be the exact op-code for <code>add x0 x1 x0</code>.</p>
<p>To verify this, we can write some assembly code:</p>
<code class="language-asm"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="co">; compile using: as sum.s -o sum.o</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="fu">sum:</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">add</span> x0<span class="op">,</span> x1<span class="op">,</span> x0</span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">ret</span></span></code></pre></div></code></pre>
<p>Using <code>objdump -d ./sum.o</code>, you&#39;ll see:</p>
<code><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a>Disassembly of section __TEXT,__text:</span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a>0000000000000000 &lt;sum&gt;:</span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a>       0: 8b000020     	add	x0, x1, x0</span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a>       4: d65f03c0     	ret</span></code></pre></div></code></pre>
<p>And there it is, the <code>0x8B000020</code> right next to our code.</p>
<h2 id="the-a64-calling-convention">The A64 calling convention</h2>
<p>Finally, let&#39;s brush up on some rules around function-calling.
There are more rules than what I will cover here, but here is all we need to keep in mind:</p>
<ol>
<li>Function arguments are passed in registers X0-X7.
</li>
<li>Return values are also stored in X0-X7.
</li>
<li>To return to caller, the <code>ret</code> instruction is used.
</li>
</ol>
<h2 id="generating-machine-code-at-runtime">Generating machine code at runtime</h2>
<code class="language-c"><div class="sourceCode"><pre class="sourceCode"><code class="sourceCode"><span id="1"><a href="#1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="2"><a href="#2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="3"><a href="#3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="4"><a href="#4" aria-hidden="true" tabindex="-1"></a></span>
<span id="5"><a href="#5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define ADD_X0_X0_X0 </span><span class="bn">0x8b000000</span></span>
<span id="6"><a href="#6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define RET          </span><span class="bn">0xd65f03c0</span></span>
<span id="7"><a href="#7" aria-hidden="true" tabindex="-1"></a></span>
<span id="8"><a href="#8" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="dt">int64_t</span> <span class="op">(*</span>twice_fn<span class="op">)(</span><span class="dt">int64_t</span><span class="op">);</span></span>
<span id="9"><a href="#9" aria-hidden="true" tabindex="-1"></a></span>
<span id="10"><a href="#10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="11"><a href="#11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1. allocate a buffer</span></span>
<span id="12"><a href="#12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span><span class="op">*</span> instrs <span class="op">=</span> malloc<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">)</span> <span class="op">*</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="13"><a href="#13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="14"><a href="#14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 2. write our instructions into that buffer</span></span>
<span id="15"><a href="#15" aria-hidden="true" tabindex="-1"></a>    instrs<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> ADD_X0_X0_X0<span class="op">;</span></span>
<span id="16"><a href="#16" aria-hidden="true" tabindex="-1"></a>    instrs<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> RET<span class="op">;</span></span>
<span id="17"><a href="#17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="18"><a href="#18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 3. cast the int* to a function pointer, </span></span>
<span id="19"><a href="#19" aria-hidden="true" tabindex="-1"></a>    <span class="co">// then call it.</span></span>
<span id="20"><a href="#20" aria-hidden="true" tabindex="-1"></a>    twice_fn twice <span class="op">=</span> <span class="op">(*</span>twice_fn<span class="op">)</span>instrs<span class="op">;</span></span>
<span id="21"><a href="#21" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;2 * 5 = </span><span class="sc">%lld\n</span><span class="st">&quot;</span><span class="op">,</span> twice<span class="op">(</span><span class="dv">5</span><span class="op">));</span></span>
<span id="22"><a href="#22" aria-hidden="true" tabindex="-1"></a></span>
<span id="23"><a href="#23" aria-hidden="true" tabindex="-1"></a>    free<span class="op">(</span>instrs<span class="op">);</span></span>
<span id="24"><a href="#24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="25"><a href="#25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div></code></pre>


			<script src="https://giscus.app/client.js" data-repo="srijan-paul/srijan-paul.github.io" data-repo-id="MDEwOlJlcG9zaXRvcnkzMTY0MTg0NTk=" data-category="Announcements" data-category-id="DIC_kwDOEtwpm84Cdokt" data-mapping="title" data-strict="0" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" defer>
			</script>
		</div>
  </body>
</html>
